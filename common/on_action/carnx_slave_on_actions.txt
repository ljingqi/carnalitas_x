carn_on_slave_enslaved = {
	effect = {
		create_character_memory = {
			type = carnx_enslaved_memory
			participants = {
				enslaver = scope:new_owner
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:new_owner PREFIX = enslaved_new_owner }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_enslaved }
	}
}

carn_on_slave_freed = {
	effect = {
		create_character_memory = {
			type = carnx_freed_memory
			participants = {
				emancipator = scope:former_owner
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:former_owner PREFIX = freed_former_owner }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_freed }
	}
}

carnx_on_slave_bought = {
	effect = {
		create_character_memory = {
			type = carnx_bought_memory
			participants = {
				buyer = scope:buyer
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:buyer PREFIX = bought_buyer }
		carnx_debug_save_scopes_effect = { CHARACTER = scope:seller PREFIX = bought_seller }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_bought }
	}
}

carnx_on_slave_seized = {
	effect = {
		create_character_memory = {
			type = carnx_seized_memory
			participants = {
				seizer = scope:new_owner
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:new_owner PREFIX = seized_new_owner }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_seized }
	}
}

carnx_on_slave_ransomed = {
	effect = {
		create_character_memory = {
			type = carnx_ransomed_memory
			participants = {
				ransomer = scope:payer
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:payer PREFIX = ransomed_payer }
		carnx_debug_save_scopes_effect = { CHARACTER = scope:former_owner PREFIX = ransomed_former_owner }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_ransomed }
	}
}

carnx_on_slave_gifted = {
	effect = {
		create_character_memory = {
			type = carnx_gifted_memory
			participants = {
				new_owner = scope:new_owner
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:new_owner PREFIX = gifted_new_owner }
		carnx_debug_save_scopes_effect = { CHARACTER = scope:former_owner PREFIX = gifted_former_owner }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_gifted }
	}
}

carnx_on_slave_escaped = {
	effect = {
		create_character_memory = {
			type = carnx_escaped_memory
			participants = {
				former_owner = scope:former_owner
			}
		}
		carnx_debug_save_scopes_effect = { CHARACTER = scope:former_owner PREFIX = escaped_former_owner }
		carnx_debug_log_effect = { MSG = carnx_debug_msg_slave_escaped }
	}
}

# Fires when a character leaves a court. Not fired when leaving due to death or similar
# Will still fire even if on_join_court is firing (fires just before it)
# Root is the character
# scope:old_employer is their old employer
on_leave_court = {
	on_actions = { carnx_on_leave_court }
}

carnx_on_leave_court = {
	effect = {
		if = {
			limit = { has_trait = slave }
			every_relation = {
				type = slave_owner
				save_scope_as = owner
			}
			if = {
				limit = {
					exists = scope:owner
					scope:owner = { is_ruler = yes }
				}
				if = {
					limit = { NOT = { is_courtier_of = scope:owner } }
					carnx_debug_log_no_details_effect = { MSG = carnx_debug_msg_moving_slave }
					scope:owner = {
						add_courtier = prev
					}
				}
			}
			else = {
				carnx_debug_log_no_details_effect = { MSG = carnx_debug_msg_freeing_slave }
				carn_free_slave_effect = yes
			}
		}
	}
}

# A title is lost by a character
# root = the old holder
# scope:title = the title that changes hands
# scope:new_holder = new holder.
on_title_lost = {
	on_actions = { carnx_on_title_lost }
}

carnx_on_title_lost = {
	effect = {
		# If a character becomes unlanded the new holder seizes their slaves
		if = {
			limit = {
				is_landed = no
				carnx_is_slave_owner_trigger = yes
			}
			every_relation = {
				type = slave
				if = {
					limit = { exists = scope:new_holder }
					scope:new_holder = { save_scope_as = new_owner }
					this = { save_scope_as = slave }
					carnx_debug_log_no_details_effect = { MSG = carnx_debug_msg_seizing_slave }
					carnx_seize_slave_effect = yes
				}
				else = {
					carnx_debug_log_no_details_effect = { MSG = carnx_debug_msg_freeing_slave }
					carn_free_slave_effect = yes
				}
			}
		}
	}
}

# Code on-action: character being imprisoned in root scope
# imprisoning character set as scope:imprisoner
on_imprison = {
	on_actions = { carnx_on_imprison }
}

carnx_on_imprison = {
	effect = {
		if = {
			limit = {
				NOT = { has_trait = slave }
			}
			carnx_debug_log_effect = { MSG = carnx_debug_msg_non_slave_imprisoned }
		}
	}
}

# Code on-action: character released from prison in root scope. Does not fire when "released" due to dying
# imprisoning character set as scope:imprisoner
on_release_from_prison = {
	on_actions = { carnx_on_release_from_prison }
}

carnx_on_release_from_prison = {
	effect = {
		if = {
			limit = {
				NOT = { has_trait = slave }
			}
			carnx_debug_log_effect = { MSG = carnx_debug_msg_non_slave_released_from_prison }
		}
	}
}

carn_on_sex = {
	on_actions = { carnx_on_sex }
}

carnx_on_sex = {
	effect = {
		#carnx_debug_log_effect = { MSG = carnx_debug_msg_character_had_sex }
	}
}

on_set_relation_rival = {
	on_actions = { carnx_on_set_relation_rival }
}

carnx_on_set_relation_rival = {
	effect = {
		if = {
			limit = {
				carnx_was_enslaved_by_character_trigger = { CHARACTER = scope:target }
			}
			carnx_debug_log_effect = { MSG = carnx_debug_msg_character_became_enslavers_rival }
		}
	}
}
